# タスク: ステートレスアーキテクチャへのリファクタリング

## 1. 目的

現在のステートフルなセッション管理（`ExportManager`）を廃止し、サーバーの再起動やクラッシュに強い、堅牢でシンプルなステートレスアーキテクチャに移行する。

## 2. 現状の問題点

- **メモリ依存**: エクスポートの進捗状況（セッション情報）がサーバーのメモリ上でのみ管理されている。
- **再起動耐性の欠如**: サーバーが再起動すると、進行中だったすべてのエクスポートセッション情報が失われ、中断した処理を再開できない。
- **複雑性**: `export_id` と `session_id` という2つの識別子が存在し、プロトコルがやや複雑になっている。
- **状態管理のオーバーヘッド**: `ExportManager` がセッションのライフサイクルを管理するためのロジックを保持する必要がある。

## 3. 提案アーキテクチャ

### 3.1. 識別子の統一
- `session_id` を、エクスポート処理全体を識別する唯一のキーとする。
- `export_id` は廃止する。

### 3.2. `ExportManager` の廃止
- インメモリでセッションを管理する `ExportManager` を廃止する。
- 各ツールはリクエストごとに完結し、サーバーは状態を保持しない。

### 3.3. 状態の動的判定
- エクスポートの進捗状況は、リクエストの都度、ファイルシステムのファイル構成から動的に判定する。
- このための新しいツール `get_export_status` を導入する。

### 3.4. 中断からの再開フロー
1. ソースAIは、処理を再開する際にまず `get_export_status` を呼び出す。
2. サーバーは、対象ディレクトリ内のファイル（`manifest.json` の有無、`conversations_*.json` の数など）を調べて現在の状態を返す。
3. ソースAIは、返された状態を基に、どこから処理を再開すればよいかを判断する（例：「`conversations` はバッチ2まで完了しているから、次はバッチ3から送ろう」）。

## 4. 具体的な修正箇所

### 4.1. `src/server/exportManager.ts`
- **アクション**: 廃止する。
- **理由**: 状態管理が不要になるため。

### 4.2. `src/tools/` 配下のエクスポート関連ツール
- `exportExperienceInit.ts`
  - `export_id` を返さず、成功した旨と `session_id`、ディレクトリパスを返すように変更。
  - `ExportManager` を呼び出さず、直接 `fileOperations` を使ってディレクトリを作成する。
- `exportExperienceConversations.ts` など
  - `export_id` の代わりに `session_id` を受け取るように変更。
  - `session_id` からディレクトリパスを導出し、直接ファイル操作を行う。

### 4.3. `src/tools/getExportStatus.ts` (新規作成)
- **アクション**: 新しいツールとして作成する。
- **機能**:
  - **入力**: `session_id`
  - **処理**:
    1. `session_id` からディレクトリパスを特定。
    2. ディレクトリ内のファイル構成を調査。
       - `manifest.json` が存在するか？ -> `completed`
       - `conversations_*.json` などが存在するか？ -> `in_progress`
       - ディレクトリのみでファイルが存在しないか？ -> `initializing`
       - ディレクトリが存在しないか？ -> `not_found`
  - **出力**: `{ status: 'in_progress', created_files: ['conversations_001.json'], next_batch_number: 2 }` のような詳細な状態を返す。

### 4.4. `src/index.ts`
- `exportManager` のインポートと関連ロジックを削除。
- 新しいツール `get_export_status` を登録。
- 各エクスポートツールの呼び出し部分を、新しいインターフェースに合わせて修正。

### 4.5. `src/types/index.ts`
- `ExportSession` 型を削除。
- `get_export_status` のための新しい出力型を定義。

### 4.6. `src/__tests__/`
- `exportManager.test.ts` を削除。
- 各エクスポートツールのテストを、ステートレスな仕様に合わせて書き直す。
- `get_export_status` のための新しいテストファイルを作成する。

## 5. 完了の定義

- [ ] `ExportManager` がプロジェクトから完全に削除されている。
- [ ] すべてのエクスポート関連ツールが `session_id` を唯一の識別子として使用し、ステートレスに動作する。
- [ ] 新しい `get_export_status` ツールが実装され、ファイルシステムの状態を正しく反映した結果を返す。
- [ ] 中断したエクスポート処理を `get_export_status` を使って再開できることが、テストまたは手動実行で確認されている。
- [ ] 関連するすべてのテストが更新され、パスしている。
- [ ] `README.md` と設計書が、新しいアーキテクチャを反映するように更新されている。

